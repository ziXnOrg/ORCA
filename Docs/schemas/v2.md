# ORCA WAL v2 Schema

Status: Final (Refactor complete)
Scope: Deterministic JSONL Write-Ahead Log (event-sourced record stream)

## Goals
- Deterministic replay with stable serialization and field order
- Forward/backward compatibility across minor schema evolution
- Clear, typed payloads per event variant; golden file regression tests

## JSONL Record (object) — field order is normative
Keys MUST be written in exactly this order by writers; readers MUST NOT depend on
order (but our golden tests assert writer order stability).

1. id (u64)
2. ts_ms (u64) — milliseconds since epoch; VirtualClock integration in later tasks
3. version (u8) — literal 2 for v2
4. event_type (string, snake_case)
5. run_id (string)
6. trace_id (string)
6. payload (object; typed per event variant)
7. attachments (array of objects; optional)
8. metadata (object; reserved for redaction flags, writer info; may be empty {})

Example lines (canonical):
- start_run
  {"id":1,"ts_ms":1000,"version":2,"event_type":"start_run","run_id":"R1","trace_id":"T1","payload":{"workflow_id":"WF1"},"metadata":{}}
- task_enqueued
  {"id":2,"ts_ms":1001,"version":2,"event_type":"task_enqueued","run_id":"R1","trace_id":"T1","payload":{"envelope_id":"EV1","agent":"a1"},"metadata":{}}
- usage_update
  {"id":3,"ts_ms":1002,"version":2,"event_type":"usage_update","run_id":"R1","trace_id":"T1","payload":{"tokens":123,"cost_micros":456789},"metadata":{}}

## Event Variants (v2)
- start_run
  - payload: { workflow_id: string }
- task_enqueued
  - payload: { envelope_id: string, agent: string } (field order as listed)
- usage_update
  - payload: { tokens: u64, cost_micros: u64 } (field order as listed)

Reserved future variants (documented, not yet implemented):
- policy_audit { phase: string, rule_name?: string, action?: string, outcome: string }
- run_summary { total_tokens: u64, total_cost_micros: u64 }
- budget_warning { remaining_tokens: u64 }
- budget_exceeded { exceeded_by_tokens: u64 }

## Determinism & Serialization
- Struct-based Serde serialization ensures stable key order; maps MUST NOT be used for
  payloads to avoid reordering.
- Numeric formatting is canonical JSON (integers); no floats in v2 core variants.
- No wall-clock dependencies on control paths; callers supply ts_ms.

## Backward/Forward Compatibility
- v1 record shape: { id, ts_ms, payload }
- v2 extends fields but preserves id, ts_ms, payload so deserialization into
  EventRecord<Value> (v1 type) continues to work; unknown fields are ignored by default.
- Version gate: `version: 2` enables future reader branching when needed.

## Golden Tests
- Fixture: crates/event-log/tests/golden/wal_v2_sample.jsonl (exact bytes, 1 trailing newline)
- Tests:
  - wal_v2_golden.rs: V2 typed serialization matches golden bytes
  - v1_v2_compat.rs: V2 records can be read by v1 EventRecord<Value>

## Notes
- Feature flagging and VirtualClock wiring will be introduced in later tasks (Phase 6a).
- Observability attributes (span/run/trace correlation) are captured via run_id/trace_id.

